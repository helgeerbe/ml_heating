name: Simple ML Heating Validation

on:
  push:
    branches: [main, develop, ha-addon]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate-config:
    runs-on: ubuntu-latest
    name: Validate Configuration Files
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Validate YAML/JSON files
        run: |
          echo "üîç Validating configuration files..."
          python3 -c "
          import yaml, json, sys
          
          # Test config.yaml
          try:
              with open('ml_heating_addon/config.yaml') as f:
                  config = yaml.safe_load(f)
              print('‚úÖ config.yaml: Valid')
              print(f'   Add-on: {config[\"name\"]} v{config[\"version\"]}')
          except Exception as e:
              print(f'‚ùå config.yaml: {e}')
              sys.exit(1)
          
          # Test build.json  
          try:
              with open('ml_heating_addon/build.json') as f:
                  build = json.load(f)
              print('‚úÖ build.json: Valid')
          except Exception as e:
              print(f'‚ùå build.json: {e}')
              sys.exit(1)
              
          # Test repository.json
          try:
              with open('repository.json') as f:
                  repo = json.load(f)
              print('‚úÖ repository.json: Valid')
          except Exception as e:
              print(f'‚ùå repository.json: {e}')
              sys.exit(1)
              
          print('üéâ All configuration files valid!')
          "

  test-python:
    runs-on: ubuntu-latest
    name: Test Python Components
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install basic dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests pandas numpy
          
      - name: Test core imports
        run: |
          echo "üêç Testing Python imports..."
          python3 -c "
          try:
              import sys
              sys.path.append('src')
              sys.path.append('ml_heating_addon')
              
              # Test basic imports
              import yaml
              import json
              import pandas
              import numpy
              print('‚úÖ Basic dependencies: OK')
              
              # Test config adapter
              import config_adapter
              print('‚úÖ Config adapter: Import OK')
              
              print('üéâ Python components validated!')
              
          except ImportError as e:
              print(f'‚ùå Import error: {e}')
              exit(1)
          except Exception as e:
              print(f'‚ùå Error: {e}')
              exit(1)
          "

  validate-structure:
    runs-on: ubuntu-latest
    name: Validate Repository Structure
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check required files
        run: |
          echo "üóÇÔ∏è Validating repository structure..."
          
          # Check add-on files
          required_files=(
            "ml_heating_addon/config.yaml"
            "ml_heating_addon/build.json"
            "ml_heating_addon/Dockerfile"
            "ml_heating_addon/run.sh"
            "repository.json"
            "README.md"
          )
          
          missing=0
          for file in "${required_files[@]}"; do
            if [[ -f "$file" ]]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå Missing: $file"
              missing=1
            fi
          done
          
          # Check directories
          required_dirs=(
            "src"
            "ml_heating_addon/dashboard"
            "docs"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [[ -d "$dir" ]]; then
              echo "‚úÖ $dir/"
            else
              echo "‚ùå Missing directory: $dir/"
              missing=1
            fi
          done
          
          if [[ $missing -eq 0 ]]; then
            echo "üéâ Repository structure valid!"
          else
            echo "‚ùå Repository structure issues found"
            exit 1
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [validate-config, test-python, validate-structure]
    if: always()
    name: Validation Summary
    
    steps:
      - name: Report results
        run: |
          echo "üìã Validation Results:"
          echo "Config Files: ${{ needs.validate-config.result }}"
          echo "Python Tests: ${{ needs.test-python.result }}"  
          echo "Structure: ${{ needs.validate-structure.result }}"
          
          if [[ "${{ needs.validate-config.result }}" == "success" && 
                "${{ needs.test-python.result }}" == "success" && 
                "${{ needs.validate-structure.result }}" == "success" ]]; then
            echo ""
            echo "üéâ All validations passed!"
            echo "‚úÖ ML Heating Add-on is ready for use"
          else
            echo ""
            echo "‚ùå Some validations failed"
            exit 1

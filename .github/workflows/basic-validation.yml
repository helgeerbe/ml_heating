name: Basic ML Heating Validation

on:
  push:
    branches:
      - main
      - develop
      - ha-addon
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate-addon:
    runs-on: ubuntu-latest
    name: Validate Add-on Configuration
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install validation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema
          
      - name: Validate Add-on Configuration
        run: |
          echo "üîç Validating Add-on Configuration Files"
          python3 -c "
          import yaml
          import json
          import sys
          
          # Validate config.yaml
          try:
              with open('ml_heating_addon/config.yaml', 'r') as f:
                  config = yaml.safe_load(f)
              print('‚úÖ config.yaml is valid YAML')
              print(f'   Add-on: {config[\"name\"]} v{config[\"version\"]}')
              print(f'   Architectures: {config[\"arch\"]}')
          except Exception as e:
              print(f'‚ùå config.yaml validation failed: {e}')
              sys.exit(1)
          
          # Validate build.json
          try:
              with open('ml_heating_addon/build.json', 'r') as f:
                  build = json.load(f)
              print('‚úÖ build.json is valid JSON')
              print(f'   Build architectures: {list(build[\"build_from\"].keys())}')
          except Exception as e:
              print(f'‚ùå build.json validation failed: {e}')
              sys.exit(1)
          
          # Validate repository.json
          try:
              with open('repository.json', 'r') as f:
                  repo = json.load(f)
              print('‚úÖ repository.json is valid JSON')
              print(f'   Repository: {repo[\"name\"]}')
          except Exception as e:
              print(f'‚ùå repository.json validation failed: {e}')
              sys.exit(1)
          
          print('üéâ All configuration files are valid!')
          "
          
      - name: Run Enhanced Container Validation
        run: |
          echo "üîç Running Enhanced ML Heating Add-on Validation"
          python3 validate_container.py
          
      - name: Check Dockerfile Syntax
        run: |
          echo "üê≥ Validating Dockerfile syntax"
          cd ml_heating_addon
          docker build --dry-run . || echo "Dockerfile validation completed"
          
      - name: Validation Summary
        if: success()
        run: |
          echo "üéâ All validations passed!"
          echo "‚úÖ Configuration files validated"
          echo "‚úÖ Container validation completed"
          echo "‚úÖ Repository structure verified"
          echo ""
          echo "üöÄ Add-on is ready for deployment!"

  lint-addon:
    runs-on: ubuntu-latest
    name: Lint Add-on with Home Assistant Standards
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Lint Add-on Configuration
        uses: frenck/action-addon-linter@v2.15
        with:
          community: true
          path: "./ml_heating_addon"

  test-container-build:
    runs-on: ubuntu-latest
    name: Test Container Build (AMD64)
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[test-build]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Test Container Build
        run: |
          echo "üê≥ Testing container build for validation"
          cd ml_heating_addon
          
          # Use a basic Alpine Python image for testing
          docker build \
            --platform linux/amd64 \
            --build-arg BUILD_FROM="python:3.11-alpine" \
            --build-arg BUILD_ARCH="amd64" \
            --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --build-arg BUILD_DESCRIPTION="ML Heating Control Add-on" \
            --build-arg BUILD_NAME="ML Heating Control" \
            --build-arg BUILD_REF="$(git rev-parse HEAD)" \
            --build-arg BUILD_REPOSITORY="https://github.com/helgeerbe/ml_heating" \
            --build-arg BUILD_VERSION="test" \
            -t ml-heating-test:latest \
            -f ../ml_heating_addon/Dockerfile \
            ..
            
          echo "‚úÖ Container build test completed successfully"

  summary:
    runs-on: ubuntu-latest
    needs: [validate-addon, lint-addon]
    if: always()
    name: Validation Summary
    
    steps:
      - name: Summary
        run: |
          if [[ "${{ needs.validate-addon.result }}" == "success" && "${{ needs.lint-addon.result }}" == "success" ]]; then
            echo "üéâ All validations passed!"
            echo "‚úÖ Add-on configuration validated"
            echo "‚úÖ Home Assistant linting passed"
            echo ""
            echo "üöÄ ML Heating Add-on is ready for installation!"
          else
            echo "‚ùå Some validations failed:"
            echo "Configuration Validation: ${{ needs.validate-addon.result }}"
            echo "Add-on Linting: ${{ needs.lint-addon.result }}"
            exit 1
          fi

name: Enhanced Container Validation

on:
  push:
    branches: [ main, develop, ha-addon ]
  pull_request:
    branches: [ main ]

jobs:
  enhanced-validation:
    name: Enhanced Quality Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install validation dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
        
    - name: Run Enhanced Container Validation
      run: |
        echo "ğŸ” Running Enhanced ML Heating Add-on Validation"
        python3 validate_container.py
        
    - name: Validate Dashboard Components
      run: |
        echo "ğŸ§© Validating Dashboard Components"
        python3 -c "
        import sys
        sys.path.append('.')
        from validate_container import validate_dashboard_components
        if not validate_dashboard_components():
            sys.exit(1)
        print('âœ… Dashboard components validation completed')
        "
        
    - name: Validate Advanced Analytics
      run: |
        echo "ğŸ“Š Validating Advanced Analytics"
        python3 -c "
        import sys
        sys.path.append('.')
        from validate_container import validate_advanced_analytics
        if not validate_advanced_analytics():
            sys.exit(1)
        print('âœ… Advanced analytics validation completed')
        "
        
    - name: Validate Backup System
      run: |
        echo "ğŸ’¾ Validating Backup System"
        python3 -c "
        import sys
        sys.path.append('.')
        from validate_container import validate_backup_system
        if not validate_backup_system():
            sys.exit(1)
        print('âœ… Backup system validation completed')
        "
        
    - name: Check Dependency Compatibility
      run: |
        echo "ğŸ”— Checking Dependency Compatibility"
        python3 -c "
        import sys
        sys.path.append('.')
        from validate_container import validate_dependency_compatibility
        if not validate_dependency_compatibility():
            sys.exit(1)
        print('âœ… Dependency compatibility check completed')
        "
        
    - name: Validation Summary
      if: success()
      run: |
        echo "ğŸ‰ All enhanced validations passed!"
        echo "âœ… Repository structure validated"
        echo "âœ… Container configuration validated"
        echo "âœ… Dashboard components validated"
        echo "âœ… Advanced analytics validated"
        echo "âœ… Backup system validated"
        echo "âœ… Dependencies validated"
        echo ""
        echo "Container is production-ready for deployment!"
        
    - name: Validation Failure
      if: failure()
      run: |
        echo "âŒ Enhanced validation failed!"
        echo "Please review the validation errors above and fix them before proceeding."
        echo ""
        echo "ğŸ’¡ Enhanced validation ensures:"
        echo "   â€¢ Dashboard components are properly structured"
        echo "   â€¢ Advanced analytics functions are available"
        echo "   â€¢ Backup/restore system is functional"
        echo "   â€¢ Dependencies are compatible"
        echo "   â€¢ API structure supports all features"
        exit 1

  container-build-test:
    name: Test Container Build
    runs-on: ubuntu-latest
    needs: enhanced-validation
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Test Container Build (AMD64)
      run: |
        echo "ğŸ³ Testing container build for validation"
        cd ml_heating_addon
        docker build --platform linux/amd64 -t ml-heating-test:latest .
        
    - name: Verify Container Health
      run: |
        echo "ğŸ¥ Testing container health check"
        # Start container in background
        docker run -d --name ml-heating-test -p 3001:3001 -p 3002:3002 ml-heating-test:latest
        
        # Wait for container to start
        sleep 30
        
        # Check health endpoint
        curl -f http://localhost:3002/health || exit 1
        
        # Clean up
        docker stop ml-heating-test
        docker rm ml-heating-test
        
        echo "âœ… Container health check passed"

  quality-gate:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [enhanced-validation, container-build-test]
    if: always()
    
    steps:
    - name: Quality Gate Status
      run: |
        if [[ "${{ needs.enhanced-validation.result }}" == "success" && "${{ needs.container-build-test.result }}" == "success" ]]; then
          echo "ğŸ‰ Quality Gate: PASSED"
          echo "âœ… Enhanced validation completed successfully"
          echo "âœ… Container build test completed successfully"
          echo ""
          echo "ğŸš€ Ready for production deployment!"
        else
          echo "âŒ Quality Gate: FAILED"
          echo "Enhanced Validation: ${{ needs.enhanced-validation.result }}"
          echo "Container Build Test: ${{ needs.container-build-test.result }}"
          echo ""
          echo "Please fix the issues before proceeding with deployment."
          exit 1
        fi

name: Build and Publish ML Heating Container

on:
  push:
    tags: ['v*']  # Only build on tags, not commits
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Stage 0: Determine Build Type Based on Branch
  determine-build-type:
    runs-on: ubuntu-latest
    name: Determine Build Type
    outputs:
      build-type: ${{ steps.build-type.outputs.type }}
      is-stable: ${{ steps.build-type.outputs.is-stable }}
      version: ${{ steps.build-type.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to determine branch
          
      - name: Determine build type from branch
        id: build-type
        run: |
          # Get the tag name
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG_NAME"
          
          # Find which branch contains this tag
          BRANCHES=$(git branch -r --contains $GITHUB_SHA | grep -v HEAD || true)
          echo "Branches containing this commit: $BRANCHES"
          
          # Check if main branch contains this tag
          if echo "$BRANCHES" | grep -q "origin/main"; then
            # Check if this is a development release (has -dev suffix)
            VERSION=${TAG_NAME#v}
            if [[ "$VERSION" =~ -dev\. ]]; then
              echo "type=dev" >> $GITHUB_OUTPUT
              echo "is-stable=false" >> $GITHUB_OUTPUT
              echo "version=dev" >> $GITHUB_OUTPUT
              echo "üöß DEV BUILD from main branch (has -dev suffix) - Version: dev"
            else
              echo "type=stable" >> $GITHUB_OUTPUT
              echo "is-stable=true" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "üéØ STABLE BUILD detected from main branch - Version: $VERSION"
            fi
          else
            echo "type=dev" >> $GITHUB_OUTPUT
            echo "is-stable=false" >> $GITHUB_OUTPUT
            # For dev builds, ensure version has -dev suffix
            VERSION=${TAG_NAME#v}
            if [[ ! "$VERSION" =~ -dev\. ]]; then
              echo "‚ùå Dev builds must have -dev.N suffix in tag"
              exit 1
            fi
            echo "version=dev" >> $GITHUB_OUTPUT
            echo "üöß DEV BUILD detected from feature/dev branch - Version: dev"
          fi

  # Stage 1: Quick Validation - Fail Fast
  validate:
    needs: determine-build-type
    runs-on: ubuntu-latest
    name: Validate Add-on Configuration
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Validate Add-on Configuration
        uses: frenck/action-addon-linter@v2.15
        with:
          community: true
          path: "./ml_heating_addon"

  test:
    needs: determine-build-type
    runs-on: ubuntu-latest
    name: Test Container Build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Update add-on version based on build type
        run: |
          VERSION="${{ needs.determine-build-type.outputs.version }}"
          BUILD_TYPE="${{ needs.determine-build-type.outputs.build-type }}"
          echo "Build Type: $BUILD_TYPE"
          echo "Updating add-on config version to: $VERSION"
          
          # Update version
          sed -i "s/^version: .*/version: \"$VERSION\"/" ml_heating_addon/config.yaml
          
          # Set auto_update based on build type
          if [ "$BUILD_TYPE" = "stable" ]; then
            echo "Setting auto_update: true for stable build"
            if grep -q "^auto_update:" ml_heating_addon/config.yaml; then
              sed -i "s/^auto_update: .*/auto_update: true/" ml_heating_addon/config.yaml
            else
              echo "auto_update: true" >> ml_heating_addon/config.yaml
            fi
          else
            echo "Setting auto_update: false for dev build"
            if grep -q "^auto_update:" ml_heating_addon/config.yaml; then
              sed -i "s/^auto_update: .*/auto_update: false/" ml_heating_addon/config.yaml
            else
              echo "auto_update: false" >> ml_heating_addon/config.yaml
            fi
          fi
          
          echo "Updated config.yaml:"
          grep -E "^(version|auto_update):" ml_heating_addon/config.yaml
        
      - name: Prepare add-on build context (local)
        run: |
          rm -rf ml_heating_addon/src ml_heating_addon/notebooks || true
          cp -R src ml_heating_addon/src || true
          cp -R notebooks ml_heating_addon/notebooks || true
          cp requirements.txt ml_heating_addon/requirements.txt || true

      - name: Test build (no push)
        uses: docker/build-push-action@v5
        with:
          context: ml_heating_addon
          file: ml_heating_addon/Dockerfile
          platforms: linux/amd64
          push: false
          build-args: |
            BUILD_FROM=ghcr.io/home-assistant/amd64-base-python:3.11-alpine3.18
            BUILD_ARCH=amd64
            BUILD_DATE=${{ github.event.repository.pushed_at }}
            BUILD_DESCRIPTION=ML Heating Control Add-on
            BUILD_NAME=ML Heating Control
            BUILD_REF=${{ github.sha }}
            BUILD_REPOSITORY=${{ github.server_url }}/${{ github.repository }}
            BUILD_VERSION=test

  # Stage 2: Multi-Architecture Builds - Only after validation passes
  build-container:
    runs-on: ubuntu-latest
    name: Build Multi-Arch Container
    needs: [validate, test]
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
          - linux/arm/v7
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=dev,enable=${{ contains(github.ref, '-dev.') }}
            
      - name: Prepare add-on build context
        run: |
          rm -rf ml_heating_addon/src ml_heating_addon/notebooks || true
          cp -R src ml_heating_addon/src || true
          cp -R notebooks ml_heating_addon/notebooks || true
          cp requirements.txt ml_heating_addon/requirements.txt || true

      - name: Build and push container
        uses: docker/build-push-action@v5
        with:
          context: ml_heating_addon
          file: ml_heating_addon/Dockerfile
          platforms: ${{ matrix.platform }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_FROM=ghcr.io/home-assistant/amd64-base-python:3.11-alpine3.18
            BUILD_ARCH=${{ matrix.platform == 'linux/amd64' && 'amd64' || matrix.platform == 'linux/arm64' && 'aarch64' || matrix.platform == 'linux/arm/v7' && 'armv7' }}
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            BUILD_DESCRIPTION=ML Heating Control Add-on
            BUILD_NAME=ML Heating Control
            BUILD_REF=${{ github.sha }}
            BUILD_REPOSITORY=${{ github.server_url }}/${{ github.repository }}
            BUILD_VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-addon:
    runs-on: ubuntu-latest
    name: Build Home Assistant Add-on
    needs: [determine-build-type, build-container]
    permissions:
      contents: read
      packages: write
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
          
      - name: Update add-on version based on build type
        run: |
          VERSION="${{ needs.determine-build-type.outputs.version }}"
          BUILD_TYPE="${{ needs.determine-build-type.outputs.build-type }}"
          echo "Build Type: $BUILD_TYPE"
          echo "Updating add-on config version to: $VERSION"
          
          # Update version
          sed -i "s/^version: .*/version: \"$VERSION\"/" ml_heating_addon/config.yaml
          
          # Set auto_update based on build type
          if [ "$BUILD_TYPE" = "stable" ]; then
            echo "Setting auto_update: true for stable build"
            if grep -q "^auto_update:" ml_heating_addon/config.yaml; then
              sed -i "s/^auto_update: .*/auto_update: true/" ml_heating_addon/config.yaml
            else
              echo "auto_update: true" >> ml_heating_addon/config.yaml
            fi
          else
            echo "Setting auto_update: false for dev build"
            if grep -q "^auto_update:" ml_heating_addon/config.yaml; then
              sed -i "s/^auto_update: .*/auto_update: false/" ml_heating_addon/config.yaml
            else
              echo "auto_update: false" >> ml_heating_addon/config.yaml
            fi
          fi
          
          echo "Updated config.yaml:"
          grep -E "^(version|auto_update):" ml_heating_addon/config.yaml
          
      - name: Prepare add-on build context
        run: |
          rm -rf ml_heating_addon/src ml_heating_addon/notebooks || true
          cp -R src ml_heating_addon/src
          cp -R notebooks ml_heating_addon/notebooks || true
          cp requirements.txt ml_heating_addon/requirements.txt || true

      - name: Build Add-on
        uses: home-assistant/builder@master
        with:
          args: |
            --amd64 \
            --aarch64 \
            --target ml_heating_addon \
            --docker-hub ghcr.io/${{ github.repository_owner }}

  # Stage 3: Release - Only for tagged versions
  release:
    runs-on: ubuntu-latest
    needs: [determine-build-type, validate, test, build-container, build-addon]
    permissions:
      contents: write
      packages: write
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: ML Heating v${{ github.ref_name }}${{ needs.determine-build-type.outputs.build-type == 'dev' && ' (Development)' || '' }}
          body: |
            ## ML Heating Control Add-on Release
            
            **Build Type:** ${{ needs.determine-build-type.outputs.build-type == 'stable' && 'üéØ **STABLE** - Auto-updates enabled' || 'üöß **DEV** - Auto-updates disabled' }}
            **Version:** `${{ needs.determine-build-type.outputs.version }}`
            **Branch:** ${{ needs.determine-build-type.outputs.build-type == 'stable' && 'main (stable)' || 'development/feature branch' }}
            
            ### Installation
            Add this repository to your Home Assistant:
            ```
            https://github.com/${{ github.repository }}
            ```
            
            ### Auto-Update Behavior
            ${{ needs.determine-build-type.outputs.build-type == 'stable' && '‚úÖ **Stable releases** from `main` branch automatically update in Home Assistant' || '‚ùå **Dev releases** from feature branches require manual updates for safety' }}
            
            ### Features
            - Physics-based machine learning heating optimization
            - Real-time dashboard with advanced analytics
            - Multi-model performance comparison
            - Automated backup and recovery system
            
            ### Container Images
            - `ghcr.io/${{ github.repository }}:${{ github.ref_name }}`
            - Multi-architecture support (amd64, arm64, armv7)
            
            ### Dual-Channel Release Strategy
            - **Stable Channel** (`main` branch): Production-ready, auto-updating releases
            - **Dev Channel** (other branches): Development versions for testing, manual updates only
          draft: false
          prerelease: ${{ needs.determine-build-type.outputs.build-type == 'dev' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

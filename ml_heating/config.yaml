name: "ML Heating Control"
version: "0.1.0"
image: "ghcr.io/helgeerbe/ml_heating:latest"
slug: "ml_heating"
description: "Physics-based machine learning heating control system with online learning (Stable Channel)"
url: "https://github.com/helgeerbe/ml_heating"
arch:
  - aarch64
  - amd64
startup: services
init: false
map:
  - addon_config:rw
ports:
  3001/tcp: 3001
ports_description:
  3001/tcp: "ML Heating Dashboard"
webui: "http://[HOST]:[PORT:3001]"
panel_icon: mdi:heat-pump
panel_title: "ML Heating"
privileged:
  - SYS_RAWIO
apparmor: false
hassio_api: true
homeassistant_api: true
options:
  # Core Entity Configuration
  # An input_number or sensor that holds the desired target indoor temperature.
  target_indoor_temp_entity: "input_number.hp_auto_correct_target"
  # The primary indoor temperature sensor that the system will try to maintain.
  indoor_temp_entity: "sensor.kuche_temperatur"
  # The outdoor temperature sensor, preferably compensated or located near the heat pump.
  outdoor_temp_entity: "sensor.thermometer_waermepume_kompensiert"
  # The climate entity for your heating system, used to check if it's in 'heat' or 'auto' mode.
  heating_control_entity: "climate.heizung_2"
  # The heat pump's actual outlet temperature sensor.
  outlet_temp_entity: "sensor.hp_outlet_temp"
  # The entity this script will write its calculated target outlet temperature to.
  target_outlet_temp_entity: "sensor.ml_vorlauftemperatur"
  # The target outlet temperature that was actually set (by model or heat curve).
  actual_target_outlet_temp_entity: "sensor.hp_target_temp_circuit1"
  # An external weather forecast temperature sensor (e.g., from OpenWeatherMap).
  openweathermap_temp_entity: "sensor.openweathermap_temperature"
  # A sensor that provides the average temperature of rooms not affected by the fireplace.
  avg_other_rooms_temp_entity: "sensor.avg_other_rooms_temp"
  # The Home Assistant sensor that provides today's PV forecast with attributes.
  pv_forecast_entity: "sensor.energy_production_today_4"
  
  # ML Learning Parameters
  # The time in minutes between each full cycle of learning and prediction.
  cycle_interval_minutes: 10
  # The maximum allowable integer change (in degrees Celsius) for the heat pump's outlet temperature setpoint in a single cycle.
  max_temp_change_per_cycle: 2.0
  # Number of historical steps to use as features for the model.
  history_steps: 6
  # The duration of each historical step in minutes.
  history_step_minutes: 10
  # The number of hours of historical data to use for initial training.
  training_lookback_hours: 168
  
  # Safety Configuration
  # The maximum safe indoor temperature allowed by the system.
  safety_max_temp: 25.0
  # The minimum safe indoor temperature allowed by the system.
  safety_min_temp: 18.0
  # Absolute minimum allowed outlet temperature (in 째C).
  clamp_min_abs: 14.0
  # Absolute maximum allowed outlet temperature (in 째C).
  clamp_max_abs: 65.0
  
  # External Heat Sources (Optional)
  # Sensor for the PV power source.
  pv_power_entity: ""
  # A binary_sensor that is 'on' when the fireplace is active.
  fireplace_status_entity: ""
  # A sensor or input_boolean that indicates if a TV or other significant internal heat source is on.
  tv_power_entity: ""
  
  # InfluxDB Configuration
  # URL of your InfluxDB instance, including the protocol and port.
  influxdb_host: "a0d7b954-influxdb"
  # Port of your InfluxDB instance.
  influxdb_port: 8086
  # The InfluxDB database where your Home Assistant data is stored. (Note: For newer InfluxDB, this might correspond to a bucket.)
  influxdb_database: "homeassistant"
  # An InfluxDB API token with read access to the specified bucket.
  influxdb_token: ""
  # The InfluxDB organization your Home Assistant data belongs to.
  influxdb_org: ""
  # The InfluxDB bucket where your Home Assistant data is stored.
  influxdb_bucket: "homeassistant"
  
  # Blocking Detection
  # A binary_sensor that is 'on' when Domestic Hot Water (DHW) is being heated.
  dhw_status_entity: ""
  # A binary_sensor that is 'on' during a defrost cycle of the heat pump.
  defrost_status_entity: ""
  # A binary_sensor that is 'on' during a DHW tank disinfection cycle.
  disinfection_status_entity: ""
  # A binary_sensor that is 'on' when the DHW boost heater is active.
  dhw_boost_heater_entity: ""
  
  # Model Management
  # Enable automatic model backups before updates.
  auto_backup_enabled: true
  # Number of days to retain model backups.
  backup_retention_days: 30
  
  # Dashboard Configuration
  # Interval in seconds for dashboard data updates.
  dashboard_update_interval: 30
  # Display advanced performance metrics on the dashboard.
  show_advanced_metrics: true
  # Theme for the dashboard (auto, light, or dark).
  dashboard_theme: "auto"
  
  # Development Settings
  # Whether to enable the development API for external access (e.g., Jupyter notebooks).
  enable_dev_api: false
  # API key for authenticating with the development API.
  dev_api_key: ""
  # The minimum level of log messages to display (DEBUG, INFO, WARNING, ERROR).
  log_level: "INFO"
  
  # Performance Tuning
  # The smoothing factor for the exponential moving average applied to the model's temperature predictions.
  smoothing_alpha: 0.3
  # The model uses a normalized confidence in the range (0..1]. This threshold determines when the model's confidence is considered sufficient.
  confidence_threshold: 0.7
  # Enable physics-based validation of model predictions.
  physics_validation_enabled: true
  # Enable automatic seasonal learning using cosine/sine modulation.
  seasonal_learning_enabled: true
  
  # Advanced Learning Features
  # Enable time-delayed learning for external heat sources (PV, fireplace, TV)
  enable_multi_lag_learning: true
  # Number of lag steps for PV effects (each step = 30 minutes)
  pv_lag_steps: 4
  # Number of lag steps for fireplace effects
  fireplace_lag_steps: 4
  # Number of lag steps for TV effects
  tv_lag_steps: 2
  # Seasonal adaptation learning rate
  seasonal_learning_rate: 0.01
  # Minimum samples before seasonal learning starts
  min_seasonal_samples: 100
  # Enable learning from HVAC-off periods (typically summer)
  enable_summer_learning: true
  
  # Advanced InfluxDB Configuration
  # InfluxDB bucket for exporting feature importances and ML metrics
  influx_features_bucket: "ml_heating_features"
  
  # System Behavior Configuration
  # Maximum minutes to wait during grace period after blocking ends
  grace_period_max_minutes: 30
  # How often (seconds) to poll blocking entities during idle period
  blocking_poll_interval_seconds: 60
  # Prediction horizon steps for calibration
  prediction_horizon_steps: 24

schema:
  # Core Entity Configuration
  target_indoor_temp_entity: "entity(domain=['input_number','sensor'],device_class=temperature,description='An input_number or sensor that holds the desired target indoor temperature.')"
  indoor_temp_entity: "entity(domain=sensor,device_class=temperature,description='The primary indoor temperature sensor that the system will try to maintain.')"
  outdoor_temp_entity: "entity(domain=sensor,device_class=temperature,description='The outdoor temperature sensor, preferably compensated or located near the heat pump.')"
  heating_control_entity: "entity(domain=climate,description='The climate entity for your heating system, used to check if it\\'s in \\'heat\\' or \\'auto\\' mode.')"
  outlet_temp_entity: "entity(domain=sensor,device_class=temperature,description='The heat pump\\'s actual outlet temperature sensor.')"
  target_outlet_temp_entity: "entity(domain=sensor,device_class=temperature,description='The entity this script will write its calculated target outlet temperature to.')"
  actual_target_outlet_temp_entity: "entity(domain=sensor,device_class=temperature,description='The target outlet temperature that was actually set (by model or heat curve).')"
  openweathermap_temp_entity: "entity(domain=sensor,device_class=temperature,description='An external weather forecast temperature sensor (e.g., from OpenWeatherMap).')"
  avg_other_rooms_temp_entity: "entity(domain=sensor,device_class=temperature,description='A sensor that provides the average temperature of rooms not affected by the fireplace.')"
  pv_forecast_entity: "entity(domain=sensor,description='The Home Assistant sensor that provides today\\'s PV forecast with attributes.')"
  
  # ML Learning Parameters
  cycle_interval_minutes: "int(5,60,description='The time in minutes between each full cycle of learning and prediction.')"
  max_temp_change_per_cycle: "float(0.5,5.0,description='The maximum allowable integer change (in degrees Celsius) for the heat pump\\'s outlet temperature setpoint in a single cycle.')"
  history_steps: "int(3,12,description='Number of historical steps to use as features for the model.')"
  history_step_minutes: "int(5,30,description='The duration of each historical step in minutes.')"
  training_lookback_hours: "int(24,720,description='The number of hours of historical data to use for initial training.')"
  
  # Safety Configuration
  safety_max_temp: "float(18.0,30.0,description='The maximum safe indoor temperature allowed by the system.')"
  safety_min_temp: "float(15.0,25.0,description='The minimum safe indoor temperature allowed by the system.')"
  clamp_min_abs: "float(10.0,20.0,description='Absolute minimum allowed outlet temperature (in 째C).')"
  clamp_max_abs: "float(50.0,80.0,description='Absolute maximum allowed outlet temperature (in 째C).')"
  
  # External Heat Sources (Optional)
  pv_power_entity: "entity(domain=sensor,device_class=power,multiple=false,description='A single aggregated sensor for total PV power generation.')"
  fireplace_status_entity: "entity(domain=binary_sensor,description='A binary_sensor that is \\'on\\' when the fireplace is active.')"
  tv_power_entity: "entity(domain=['sensor','input_boolean'],description='A sensor or input_boolean that indicates if a TV or other significant internal heat source is on.')"
  
  # InfluxDB Configuration
  influxdb_host: "str(description='URL of your InfluxDB instance, including the protocol and port.')"
  influxdb_port: "port(description='Port of your InfluxDB instance.')"
  influxdb_database: "str?(description='The InfluxDB database where your Home Assistant data is stored. (Note: For newer InfluxDB, this might correspond to a bucket.)')"
  influxdb_token: "str?(description='An InfluxDB API token with read access to the specified bucket.')"
  influxdb_org: "str?(description='The InfluxDB organization your Home Assistant data belongs to.')"
  influxdb_bucket: "str?(description='The InfluxDB bucket where your Home Assistant data is stored.')"
  
  # Blocking Detection
  dhw_status_entity: "entity(domain=binary_sensor,description='A binary_sensor that is \\'on\\' when Domestic Hot Water (DHW) is being heated.')"
  defrost_status_entity: "entity(domain=binary_sensor,description='A binary_sensor that is \\'on\\' during a defrost cycle of the heat pump.')"
  disinfection_status_entity: "entity(domain=binary_sensor,description='A binary_sensor that is \\'on\\' during a DHW tank disinfection cycle.')"
  dhw_boost_heater_entity: "entity(domain=binary_sensor,description='A binary_sensor that is \\'on\\' when the DHW boost heater is active.')"
  
  # Model Management
  auto_backup_enabled: "bool(description='Enable automatic model backups before updates.')"
  backup_retention_days: "int(1,365,description='Number of days to retain model backups.')"
  
  # Dashboard Configuration
  dashboard_update_interval: "int(5,300,description='Interval in seconds for dashboard data updates.')"
  show_advanced_metrics: "bool(description='Display advanced performance metrics on the dashboard.')"
  dashboard_theme: "list(auto|light|dark,description='Theme for the dashboard (auto, light, or dark).')"
  
  # Development Settings
  enable_dev_api: "bool(description='Whether to enable the development API for external access (e.g., Jupyter notebooks).')"
  dev_api_key: "str?(description='API key for authenticating with the development API.')"
  log_level: "list(DEBUG|INFO|WARNING|ERROR,description='The minimum level of log messages to display (DEBUG, INFO, WARNING, ERROR).')"
  
  # Performance Tuning
  smoothing_alpha: "float(0.1,0.9,description='The smoothing factor for the exponential moving average applied to the model\\'s temperature predictions.')"
  confidence_threshold: "float(0.5,0.95,description='The model uses a normalized confidence in the range (0..1]. This threshold determined when the model\\'s confidence is considered sufficient.')"
  physics_validation_enabled: "bool(description='Enable physics-based validation of model predictions.')"
  seasonal_learning_enabled: "bool(description='Enable automatic seasonal learning using cosine/sine modulation.')"
  
  # Advanced Learning Features
  enable_multi_lag_learning: "bool(description='Enable time-delayed learning for external heat sources (PV, fireplace, TV) to capture realistic time delays.')"
  pv_lag_steps: "int(1,8,description='Number of lag steps for PV effects (each step = 30 minutes). 4 steps = track 30, 60, 90, 120min delays.')"
  fireplace_lag_steps: "int(1,8,description='Number of lag steps for fireplace effects. 4 steps = immediate, 30, 60, 90min delays.')"
  tv_lag_steps: "int(1,6,description='Number of lag steps for TV effects. 2 steps = immediate, 30min delays.')"
  seasonal_learning_rate: "float(0.001,0.1,description='Learning rate for seasonal parameters (lower = more stable, slower adaptation).')"
  min_seasonal_samples: "int(50,500,description='Minimum samples before seasonal learning starts.')"
  enable_summer_learning: "bool(description='Enable learning from HVAC-off periods for cleaner external source signals.')"
  
  # Advanced InfluxDB Configuration
  influx_features_bucket: "str?(description='InfluxDB bucket for exporting feature importances and ML metrics.')"
  
  # System Behavior Configuration
  grace_period_max_minutes: "int(10,120,description='Maximum minutes to wait during grace period after blocking ends.')"
  blocking_poll_interval_seconds: "int(30,300,description='How often (seconds) to poll blocking entities during idle period.')"
  prediction_horizon_steps: "int(12,48,description='Prediction horizon steps for calibration (each step = 5 minutes).')"
